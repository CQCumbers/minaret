# Minaret
> Experimental MINA32 CPU

Minaret is an experimental softcore CPU and lightweight system-on-chip based on subset of the [MINA instruction set architecture](https://github.com/ladystarbreeze/mina-isa/blob/main/MINA_Instruction_Set_Architecture.md). It is designed for use on FPGAs both by itself and as part of a larger system. Minaret also serves as a demo system for the [MINA32 toolchain](https://github.com/CQCumbers/mina32-llvm) and as a reference for people designing more powerful and complete CPUs for this ISA. Personally, it's a way to explore hardware design, learn about the low-level foundations of computing, and test my MINA32 software on a real system.

The CPU is a multi-cycle implementation that prioritizes readability at the expense of size and speed. Most user mode instructions are supported, while supervisor behaviors like interrupts, syscalls, and fault handling are not. Instruction fetching and data access use seperate 32-bit busses, both with a simple valid/ready interface similar to that of [PicoRV32](https://github.com/cliffordwolf/picorv32#picorv32-native-memory-interface). The core itself is written in platform-independent Verilog and tested using a partial port of [riscv-formal](https://github.com/SymbioticEDA/riscv-formal). The rest of the system-on-chip is designed around the [Arrow DECA](https://tomverbeure.github.io/2021/04/23/Arrow-DECA-FPGA-board.html), a MAX10 development board with builtin DDR3 memory and an HDMI port. Accordingly, the SoC is designed to include a DDR3 controller and direct-mapped cache, as well as a display controller, keyboard controller, timer, and UART interface. These peripherals make use of Quartus and MAX10-specific code, and have only been tested on the DECA. The linker script and bootloader, as well as support functions for the peripherals, are included along with example programs exercising them. An instruction-level simulator with extensive debugger support can help with writing your own software.

## Todo List
- Write example programs for peripherals
- Reorganize software files
- Distribute prebuilt toolchain

## Build
Building the example system requires an Arrow DECA board and a copy of Quartus - just open `minaret-test.qpf`. The project includes a prebuilt UART bootloader ROM, which will request an intel hex file with your main program image. This hex file can be generated by running `llvm-objcopy -O ihex <ELF> <HEX>` on the ELF binary created by clang (Check the hello world Makefile for more details). The simulator does not require a bootloader, and takes ELF files directly.

For building software, Minaret uses a completely LLVM based cross-compilation toolchain, with newlib as the preferred standard library. To get started, you will need custom copies of [LLVM](https://github.com/CQCumbers/mina32-llvm) and [newlib](https://github.com/CQCumbers/mina32-newlib). See `sw/notes.txt` for MINA32 specific build information.

## Resources
- [riscv-formal](https://github.com/SymbioticEDA/riscv-formal) is great for finding CPU bugs without digging through massive simulator traces.
- [Using SDRAM with FPGAs](https://www.joshbassett.info/sdram-controller/) explains DRAM controller logic, even if not DDR3 specific.
- [Oldland CPU](https://jamieiles.github.io/oldland-cpu/) is an inspiring example of all the bits needed to make a hobby CPU architecture real.
- [Intel JTAG UART](https://github.com/tomverbeure/intel_jtag_uart) makes is easier to communicate with FPGAs without extra cables (or extra TCL).
- [NeoRV32](https://github.com/stnolting/neorv32) has amazingly clear organization and extensive documention for an open source CPU.
- [RISC-V LLVM patchset](https://github.com/lowRISC/riscv-llvm) is an invaluable guide to gradually building up an LLVM backend.
- [LLVM Toolchains](https://wiki.osdev.org/User:MessiahAndrw/LLVM_OS_Specific_Toolchain) can help with porting components like the linker and compiler driver.
- [Embecosm Appnotes](https://www.embecosm.com/resources/appnotes/) contain useful reference for porting tools that improve the usability of any CPU design, like gdb remote and newlib.
